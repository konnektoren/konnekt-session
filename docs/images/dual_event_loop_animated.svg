<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg
  xmlns="http://www.w3.org/2000/svg"
  xmlns:xlink="http://www.w3.org/1999/xlink"
  width="900"
  height="320"
  viewBox="0 0 900 320"
  aria-labelledby="title desc"
  role="img">
  <title id="title">Dual Event Loop with Anti-Corruption Layer</title>
  <desc id="desc">Animated diagram showing P2P Event Loop, Anti-Corruption Layer and Domain Event Loop with messages flowing between them.</desc>

  <defs>
    <!-- Arrow marker for paths -->
    <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5"
            markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#2d3748" />
    </marker>

    <!-- Styles -->
    <style><![CDATA[
      .box { fill: #f7fafc; stroke: #2d3748; stroke-width: 2; rx: 8; ry: 8; }
      .label { font-family: Inter, Arial, sans-serif; fill: #1a202c; font-size: 14px; font-weight: 600; }
      .sub { font-family: Inter, Arial, sans-serif; fill: #4a5568; font-size: 12px; }
      .lane { fill: none; stroke: #e2e8f0; stroke-width: 1; stroke-dasharray: 4 4; }
      .dot-cmd { fill: #218a8a; }
      .dot-evt { fill: #dd6b20; }
      .connector { stroke: #2d3748; stroke-width: 2; fill: none; marker-end: url(#arrow); opacity: 0.6; }
    ]]></style>
  </defs>

  <!-- Runtime / Orchestrator -->
  <g transform="translate(0,0)">
    <rect x="300" y="10" width="300" height="36" rx="6" ry="6" class="box" />
    <text x="450" y="34" text-anchor="middle" class="label">Runtime / Orchestrator</text>
  </g>

  <!-- Lanes -->
  <line x1="0" y1="80" x2="900" y2="80" class="lane" />
  <line x1="0" y1="160" x2="900" y2="160" class="lane" />
  <line x1="0" y1="240" x2="900" y2="240" class="lane" />

  <!-- Boxes -->
  <!-- P2P -->
  <g id="p2p" transform="translate(40,50)">
    <rect width="220" height="120" class="box" />
    <text x="110" y="30" text-anchor="middle" class="label">P2P Event Loop</text>
    <text x="110" y="52" text-anchor="middle" class="sub">WebRTC, Matchbox, PeerRegistry</text>
  </g>

  <!-- ACL -->
  <g id="acl" transform="translate(340,50)">
    <rect width="220" height="120" class="box" />
    <text x="110" y="30" text-anchor="middle" class="label">Anti-Corruption Layer</text>
    <text x="110" y="52" text-anchor="middle" class="sub">Message Translator / Queues</text>
  </g>

  <!-- Domain -->
  <g id="domain" transform="translate(640,50)">
    <rect width="220" height="120" class="box" />
    <text x="110" y="30" text-anchor="middle" class="label">Domain Event Loop</text>
    <text x="110" y="52" text-anchor="middle" class="sub">Lobby, Participants, Activities</text>
  </g>

  <!-- Connectors (static arrows for context) -->
  <path d="M 260 110 L 340 110" class="connector" />
  <path d="M 560 110 L 640 110" class="connector" />

  <!-- Paths used for animation -->
  <!-- P2P -> ACL -> Domain path -->
  <path id="path_cmd" d="M 260 120 C 320 120 360 120 420 120 C 480 120 520 120 580 120 C 620 120 660 120 700 120" stroke="transparent" fill="none" />
  <!-- Domain -> ACL -> P2P path (reverse) -->
  <path id="path_evt" d="M 700 140 C 660 140 620 140 580 140 C 520 140 480 140 420 140 C 360 140 320 140 260 140" stroke="transparent" fill="none" />

  <!-- Animated dots moving from P2P -> ACL -> Domain (commands) -->
  <g aria-hidden="true">
    <circle r="6" class="dot-cmd">
      <animateMotion dur="2.6s" repeatCount="indefinite" rotate="auto">
        <mpath xlink:href="#path_cmd" />
      </animateMotion>
      <animate attributeName="opacity" values="0.0;1;1;0.0" dur="2.6s" repeatCount="indefinite" />
    </circle>

    <!-- Staggered second command dot to show continuous flow -->
    <circle r="6" class="dot-cmd">
      <set attributeName="visibility" to="visible" />
      <animateMotion begin="1.1s" dur="2.6s" repeatCount="indefinite" rotate="auto">
        <mpath xlink:href="#path_cmd" />
      </animateMotion>
      <animate attributeName="opacity" begin="1.1s" values="0.0;1;1;0.0" dur="2.6s" repeatCount="indefinite" />
    </circle>
  </g>

  <!-- Animated dots moving from Domain -> ACL -> P2P (events) -->
  <g aria-hidden="true">
    <circle r="6" class="dot-evt">
      <animateMotion dur="2.6s" repeatCount="indefinite" rotate="auto">
        <mpath xlink:href="#path_evt" />
      </animateMotion>
      <animate attributeName="opacity" values="0.0;1;1;0.0" dur="2.6s" repeatCount="indefinite" />
    </circle>

    <!-- Staggered second event dot -->
    <circle r="6" class="dot-evt">
      <animateMotion begin="0.9s" dur="2.6s" repeatCount="indefinite" rotate="auto">
        <mpath xlink:href="#path_evt" />
      </animateMotion>
      <animate attributeName="opacity" begin="0.9s" values="0.0;1;1;0.0" dur="2.6s" repeatCount="indefinite" />
    </circle>
  </g>

  <!-- Legend -->
  <g transform="translate(20,200)">
    <rect x="0" y="0" width="860" height="100" rx="6" ry="6" fill="#ffffff" stroke="#e2e8f0" />
    <g transform="translate(10,20)">
      <circle cx="12" cy="12" r="6" class="dot-cmd" />
      <text x="28" y="17" class="sub">P2P → Domain (DomainCommand)</text>

      <circle cx="320" cy="12" r="6" class="dot-evt" />
      <text x="336" y="17" class="sub">Domain → P2P (DomainEvent)</text>
    </g>
    <g transform="translate(10,50)">
      <text x="0" y="17" class="sub">Runtime polls both loops; ACL wires queues between them</text>
    </g>
  </g>

  <!-- Gentle pulsing highlight of ACL box to emphasize translator -->
  <rect x="340" y="50" width="220" height="120" rx="8" ry="8" fill="none" stroke="#38b2ac" stroke-width="0.5">
    <animate attributeName="stroke-width" values="0.5;2.5;0.5" dur="3.2s" repeatCount="indefinite" />
    <animate attributeName="opacity" values="0.5;1;0.5" dur="3.2s" repeatCount="indefinite"/>
  </rect>
</svg>
