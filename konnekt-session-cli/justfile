# Default recipe
default:
    @just --list

# Run CLI with custom args
run *ARGS:
    cargo run -- {{ ARGS }}

# Create a host session (example)
host NAME="TestHost":
    cargo run -- create-host --name "{{ NAME }}"

# Join a session (example - requires session ID)
join SESSION_ID NAME="TestGuest":
    cargo run -- join --session-id "{{ SESSION_ID }}" --name "{{ NAME }}"

# Create a host with TURN server
host-turn NAME TURN_SERVER TURN_USER TURN_PASS:
    cargo run -- create-host --name "{{ NAME }}" \
        --turn-server "{{ TURN_SERVER }}" \
        --turn-username "{{ TURN_USER }}" \
        --turn-credential "{{ TURN_PASS }}"

# Create a host session (TUI)
host-tui NAME="TestHost":
    cargo run --bin konnekt-tui --features tui -- create-host --name "{{ NAME }}"

# Join a session (TUI)
join-tui SESSION_ID NAME="TestGuest":
    cargo run --bin konnekt-tui --features tui -- join --session-id "{{ SESSION_ID }}" --name "{{ NAME }}"

# üÜï Run with tokio-console enabled (host)
host-console NAME="TestHost":
    @echo "üîç Starting with tokio-console enabled"
    @echo "   Run 'tokio-console' in another terminal to connect"
    @echo ""
    TOKIO_CONSOLE=1 RUSTFLAGS="--cfg tokio_unstable" cargo run --features console -- create-host --name "{{ NAME }}"

# üÜï Run with tokio-console enabled (guest)
join-console SESSION_ID NAME="TestGuest":
    @echo "üîç Starting with tokio-console enabled"
    @echo "   Run 'tokio-console' in another terminal to connect"
    @echo ""
    TOKIO_CONSOLE=1 RUSTFLAGS="--cfg tokio_unstable" cargo run --features console -- join --session-id "{{ SESSION_ID }}" --name "{{ NAME }}"

# üÜï Run TUI with tokio-console enabled (host)
host-tui-console NAME="TestHost":
    @echo "üîç Starting TUI with tokio-console enabled"
    @echo "   Run 'tokio-console' in another terminal to connect"
    @echo ""
    TOKIO_CONSOLE=1 RUSTFLAGS="--cfg tokio_unstable" cargo run --bin konnekt-tui --features "tui,chrome-trace" -- create-host --name "{{ NAME }}"

# üÜï Run TUI with tokio-console enabled (guest)
join-tui-console SESSION_ID NAME="TestGuest":
    @echo "üîç Starting TUI with tokio-console enabled"
    @echo "   Run 'tokio-console' in another terminal to connect"
    @echo ""
    TOKIO_CONSOLE=1 RUSTFLAGS="--cfg tokio_unstable" cargo run --bin konnekt-tui --features "tui,console" -- join --session-id "{{ SESSION_ID }}" --name "{{ NAME }}"

# üÜï Install tokio-console (if not already installed)
install-tokio-console:
    cargo install --locked tokio-console

# üÜï Open tokio-console in new terminal (requires 'screen' or 'tmux')
console:
    @echo "Opening tokio-console..."
    tokio-console

# üÜï Run host + console in split terminal (tmux)
host-with-console NAME="TestHost":
    #!/usr/bin/env bash
    tmux new-session -d -s konnekt "just host-console {{ NAME }}"
    tmux split-window -h -t konnekt "sleep 2 && tokio-console"
    tmux attach-session -t konnekt

# üÜï Kill tmux session
kill-console:
    tmux kill-session -t konnekt || true
